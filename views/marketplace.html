<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Marketplace - TuBlox</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- Currency Styles --- */
        .currency-badge {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #333;
            margin-right: 15px;
        }
        .currency-icon { width: 20px; height: 20px; margin-right: 8px; }
        .currency-amount { color: #fff; font-weight: bold; font-family: 'Verdana', sans-serif; }
        .header-right { display: flex; align-items: center; }

        /* --- Price Tag Style --- */
        .price-tag {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 5px 10px;
            margin-top: 5px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .price-tag img { width: 16px; height: 16px; margin-right: 5px; }
        .price-tag span { color: #00ff00; font-weight: bold; font-size: 0.9rem; }

        /* Контейнер для 3D превью */
        .preview-box {
            height: 140px;
            background: radial-gradient(circle, #3a3d42 0%, #1a1a1a 100%);
            border-bottom: 1px solid #333;
            overflow: hidden;
        }
        .preview-box canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body>
    <header>
        <div class="logo-area">
            <img src="/assets/logo.png" style="width:40px; margin-right:10px;">
            <h1>TuBlox 3</h1>
            <nav class="main-nav">
                <a href="/" class="nav-link">Games</a>
                <a href="/marketplace.html" class="nav-link active">Marketplace</a>
            </nav>
        </div>
        
        <div class="header-right">
             <div class="currency-badge" title="Your Tubux">
                <img src="/assets/tubux.png" alt="T$" class="currency-icon">
                <span id="tubux-display" class="currency-amount">...</span>
            </div>
        </div>
    </header>

    <h2 style="text-align: center; margin-top: 30px;">Official Store by <span style="color:var(--accent-color)">TuBlox</span></h2>

    <div id="market-grid" style="display: flex; flex-wrap: wrap; gap: 20px; padding: 30px; justify-content: center;">
        <!-- Карточки будут здесь -->
    </div>

    <script>
        // Получаем баланс
        fetch('/api/me').then(r=>r.json()).then(user => {
            document.getElementById('tubux-display').textContent = user.tubux;
        });

        // Загружаем товары
        fetch('/api/items').then(r=>r.json()).then(items => {
            const container = document.getElementById('market-grid');
            
            Object.values(items).forEach(item => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.style.width = '220px';
                
                // Генерируем уникальный ID для контейнера 3D
                const canvasId = `preview-${item.id}`;

                card.innerHTML = `
                    <div id="${canvasId}" class="preview-box"></div>
                    <div class="card-info" style="text-align:center;">
                        <h3 style="font-size:1rem; margin-bottom:2px;">${item.name}</h3>
                        <p style="font-size:0.7rem; color:#888; margin-top:0;">${item.type.toUpperCase()}</p>
                        
                        <!-- Красивая цена -->
                        <div class="price-tag">
                            <img src="/assets/tubux.png" alt="T$">
                            <span>${item.price}</span>
                        </div>

                        <button class="action-btn" style="width:100%; margin-top:10px;" onclick="buy('${item.id}')">Buy</button>
                    </div>
                `;
                container.appendChild(card);

                // Запускаем рендер после добавления в DOM
                setTimeout(() => render3DPreview(canvasId, item), 0);
            });
        });

        function buy(itemId) {
            fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ itemId })
            }).then(r => r.text()).then(msg => {
                alert(msg);
                location.reload();
            });
        }

        // --- ФУНКЦИЯ РЕНДЕРА ПРЕДМЕТОВ ---
        function render3DPreview(elementId, item) {
            const container = document.getElementById(elementId);
            if(!container) return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 100);
            camera.position.z = 2.5;
            camera.position.y = 0.5;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Свет
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(1, 1, 2);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            const group = new THREE.Group();

            // Логика создания моделей (похоже на createPlayerModel)
            if (item.type === 'shirt') {
                const mat = new THREE.MeshLambertMaterial({ color: item.color });
                // Торс
                const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.5), mat);
                group.add(body);
                // Рука Л
                const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.2, 0.3), mat);
                lArm.position.set(-0.75, 0, 0);
                group.add(lArm);
                // Рука П
                const rArm = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.2, 0.3), mat);
                rArm.position.set(0.75, 0, 0);
                group.add(rArm);
            } 
            else if (item.type === 'pants') {
                const mat = new THREE.MeshLambertMaterial({ color: item.color });
                // Нога Л
                const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1.2, 0.4), mat);
                lLeg.position.set(-0.25, 0, 0);
                group.add(lLeg);
                // Нога П
                const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1.2, 0.4), mat);
                rLeg.position.set(0.25, 0, 0);
                group.add(rLeg);
            } 
            else if (item.type === 'hat') {
                const mat = new THREE.MeshLambertMaterial({ color: 0x111111 });
                if(item.model === 'tophat') {
                    const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.1, 12), mat);
                    const top = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.8, 12), mat);
                    top.position.y = 0.45;
                    group.add(brim);
                    group.add(top);
                    group.position.y = -0.2;
                } else {
                    // Если шляпы нет (No Hat)
                    // Рисуем прозрачный куб или ничего
                }
            }

            scene.add(group);

            function animate() {
                requestAnimationFrame(animate);
                group.rotation.y += 0.015; // Вращение
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>
</html>